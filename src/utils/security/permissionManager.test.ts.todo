/**
 * Test suite for Permission Manager
 *
 * @module permissionManager.test
 */

import { describe, it, expect } from "@jest/globals";
import {
  AutonomyLevel,
  OperationType,
  checkPermission,
  assertPermission,
  getDefaultAutonomyLevel,
  isValidAutonomyLevel,
  getAllowedOperations,
  GitOperations,
  FileOperations,
  PermissionManager,
  createPermissionManager
} from "./permissionManager.js";

describe("PermissionManager", () => {
  describe("checkPermission", () => {
    it("should allow READ_FILE at READ_ONLY level", () => {
      const result = checkPermission(
        AutonomyLevel.READ_ONLY,
        OperationType.READ_FILE
      );
      expect(result.allowed).toBe(true);
    });

    it("should deny WRITE_FILE at READ_ONLY level", () => {
      const result = checkPermission(
        AutonomyLevel.READ_ONLY,
        OperationType.WRITE_FILE
      );
      expect(result.allowed).toBe(false);
      expect(result.reason).toContain("requires 'low'");
      expect(result.requiredLevel).toBe(AutonomyLevel.LOW);
    });

    it("should allow WRITE_FILE at LOW level", () => {
      const result = checkPermission(
        AutonomyLevel.LOW,
        OperationType.WRITE_FILE
      );
      expect(result.allowed).toBe(true);
    });

    it("should deny GIT_COMMIT at LOW level", () => {
      const result = checkPermission(
        AutonomyLevel.LOW,
        OperationType.GIT_COMMIT
      );
      expect(result.allowed).toBe(false);
      expect(result.requiredLevel).toBe(AutonomyLevel.MEDIUM);
    });

    it("should allow GIT_COMMIT at MEDIUM level", () => {
      const result = checkPermission(
        AutonomyLevel.MEDIUM,
        OperationType.GIT_COMMIT
      );
      expect(result.allowed).toBe(true);
    });

    it("should deny GIT_PUSH at MEDIUM level", () => {
      const result = checkPermission(
        AutonomyLevel.MEDIUM,
        OperationType.GIT_PUSH
      );
      expect(result.allowed).toBe(false);
      expect(result.requiredLevel).toBe(AutonomyLevel.HIGH);
    });

    it("should allow GIT_PUSH at HIGH level", () => {
      const result = checkPermission(
        AutonomyLevel.HIGH,
        OperationType.GIT_PUSH
      );
      expect(result.allowed).toBe(true);
    });

    it("should allow all operations at HIGH level", () => {
      const operations = Object.values(OperationType);
      operations.forEach((operation) => {
        const result = checkPermission(AutonomyLevel.HIGH, operation);
        expect(result.allowed).toBe(true);
      });
    });
  });

  describe("assertPermission", () => {
    it("should not throw for allowed operations", () => {
      expect(() => {
        assertPermission(AutonomyLevel.LOW, OperationType.WRITE_FILE);
      }).not.toThrow();
    });

    it("should throw for denied operations", () => {
      expect(() => {
        assertPermission(AutonomyLevel.READ_ONLY, OperationType.WRITE_FILE);
      }).toThrow("Permission denied");
    });

    it("should include context in error message", () => {
      expect(() => {
        assertPermission(
          AutonomyLevel.LOW,
          OperationType.GIT_PUSH,
          "pushing to remote"
        );
      }).toThrow("pushing to remote");
    });

    it("should suggest required autonomy level in error", () => {
      expect(() => {
        assertPermission(AutonomyLevel.MEDIUM, OperationType.GIT_PUSH);
      }).toThrow("Increase autonomy level to 'high'");
    });
  });

  describe("getDefaultAutonomyLevel", () => {
    it("should return READ_ONLY as default", () => {
      expect(getDefaultAutonomyLevel()).toBe(AutonomyLevel.READ_ONLY);
    });
  });

  describe("isValidAutonomyLevel", () => {
    it("should return true for valid levels", () => {
      expect(isValidAutonomyLevel("read-only")).toBe(true);
      expect(isValidAutonomyLevel("low")).toBe(true);
      expect(isValidAutonomyLevel("medium")).toBe(true);
      expect(isValidAutonomyLevel("high")).toBe(true);
    });

    it("should return false for invalid levels", () => {
      expect(isValidAutonomyLevel("invalid")).toBe(false);
      expect(isValidAutonomyLevel("super-high")).toBe(false);
      expect(isValidAutonomyLevel("")).toBe(false);
    });
  });

  describe("getAllowedOperations", () => {
    it("should return only read operations for READ_ONLY", () => {
      const allowed = getAllowedOperations(AutonomyLevel.READ_ONLY);
      expect(allowed).toContain(OperationType.READ_FILE);
      expect(allowed).toContain(OperationType.GIT_READ);
      expect(allowed).toContain(OperationType.MCP_CALL);
      expect(allowed).not.toContain(OperationType.WRITE_FILE);
      expect(allowed).not.toContain(OperationType.GIT_COMMIT);
    });

    it("should include write operations for LOW", () => {
      const allowed = getAllowedOperations(AutonomyLevel.LOW);
      expect(allowed).toContain(OperationType.READ_FILE);
      expect(allowed).toContain(OperationType.WRITE_FILE);
      expect(allowed).not.toContain(OperationType.GIT_COMMIT);
    });

    it("should include git operations for MEDIUM", () => {
      const allowed = getAllowedOperations(AutonomyLevel.MEDIUM);
      expect(allowed).toContain(OperationType.GIT_COMMIT);
      expect(allowed).toContain(OperationType.GIT_BRANCH);
      expect(allowed).toContain(OperationType.INSTALL_DEPENDENCY);
      expect(allowed).not.toContain(OperationType.GIT_PUSH);
    });

    it("should include all operations for HIGH", () => {
      const allowed = getAllowedOperations(AutonomyLevel.HIGH);
      const allOperations = Object.values(OperationType);
      expect(allowed.length).toBe(allOperations.length);
      allOperations.forEach((op) => {
        expect(allowed).toContain(op);
      });
    });
  });

  describe("GitOperations", () => {
    it("should allow read at READ_ONLY level", () => {
      const git = new GitOperations(AutonomyLevel.READ_ONLY);
      expect(git.canRead()).toBe(true);
      expect(git.canCommit()).toBe(false);
      expect(git.canPush()).toBe(false);
    });

    it("should allow commit at MEDIUM level", () => {
      const git = new GitOperations(AutonomyLevel.MEDIUM);
      expect(git.canRead()).toBe(true);
      expect(git.canCommit()).toBe(true);
      expect(git.canPush()).toBe(false);
    });

    it("should allow push at HIGH level", () => {
      const git = new GitOperations(AutonomyLevel.HIGH);
      expect(git.canRead()).toBe(true);
      expect(git.canCommit()).toBe(true);
      expect(git.canPush()).toBe(true);
    });

    it("should assert commit permission", () => {
      const git = new GitOperations(AutonomyLevel.MEDIUM);
      expect(() => git.assertCommit()).not.toThrow();
    });

    it("should throw on assertCommit if not allowed", () => {
      const git = new GitOperations(AutonomyLevel.LOW);
      expect(() => git.assertCommit("creating commit")).toThrow(
        "Permission denied"
      );
    });

    it("should assert push permission", () => {
      const git = new GitOperations(AutonomyLevel.HIGH);
      expect(() => git.assertPush()).not.toThrow();
    });

    it("should throw on assertPush if not allowed", () => {
      const git = new GitOperations(AutonomyLevel.MEDIUM);
      expect(() => git.assertPush("pushing to remote")).toThrow(
        "Permission denied"
      );
    });
  });

  describe("FileOperations", () => {
    it("should allow read at READ_ONLY level", () => {
      const file = new FileOperations(AutonomyLevel.READ_ONLY);
      expect(file.canRead()).toBe(true);
      expect(file.canWrite()).toBe(false);
    });

    it("should allow write at LOW level", () => {
      const file = new FileOperations(AutonomyLevel.LOW);
      expect(file.canRead()).toBe(true);
      expect(file.canWrite()).toBe(true);
    });

    it("should assert write permission", () => {
      const file = new FileOperations(AutonomyLevel.LOW);
      expect(() => file.assertWrite()).not.toThrow();
    });

    it("should throw on assertWrite if not allowed", () => {
      const file = new FileOperations(AutonomyLevel.READ_ONLY);
      expect(() => file.assertWrite("writing file")).toThrow(
        "Permission denied"
      );
    });
  });

  describe("PermissionManager", () => {
    it("should create with default READ_ONLY level", () => {
      const pm = new PermissionManager();
      expect(pm.getLevel()).toBe(AutonomyLevel.READ_ONLY);
    });

    it("should create with custom level", () => {
      const pm = new PermissionManager(AutonomyLevel.HIGH);
      expect(pm.getLevel()).toBe(AutonomyLevel.HIGH);
    });

    it("should provide git operations wrapper", () => {
      const pm = new PermissionManager(AutonomyLevel.MEDIUM);
      expect(pm.git.canCommit()).toBe(true);
      expect(pm.git.canPush()).toBe(false);
    });

    it("should provide file operations wrapper", () => {
      const pm = new PermissionManager(AutonomyLevel.LOW);
      expect(pm.file.canRead()).toBe(true);
      expect(pm.file.canWrite()).toBe(true);
    });

    it("should check permissions via check method", () => {
      const pm = new PermissionManager(AutonomyLevel.MEDIUM);
      const result = pm.check(OperationType.GIT_COMMIT);
      expect(result.allowed).toBe(true);
    });

    it("should assert permissions via assert method", () => {
      const pm = new PermissionManager(AutonomyLevel.HIGH);
      expect(() => pm.assert(OperationType.GIT_PUSH)).not.toThrow();
    });

    it("should get allowed operations", () => {
      const pm = new PermissionManager(AutonomyLevel.LOW);
      const allowed = pm.getAllowedOperations();
      expect(allowed).toContain(OperationType.WRITE_FILE);
      expect(allowed).not.toContain(OperationType.GIT_COMMIT);
    });
  });

  describe("createPermissionManager", () => {
    it("should create with default level if no level provided", () => {
      const pm = createPermissionManager();
      expect(pm.getLevel()).toBe(AutonomyLevel.READ_ONLY);
    });

    it("should create with specified level", () => {
      const pm = createPermissionManager(AutonomyLevel.HIGH);
      expect(pm.getLevel()).toBe(AutonomyLevel.HIGH);
    });
  });

  describe("Permission hierarchy validation", () => {
    it("should respect hierarchy: READ_ONLY < LOW < MEDIUM < HIGH", () => {
      // READ_ONLY can only do read operations
      expect(
        checkPermission(AutonomyLevel.READ_ONLY, OperationType.READ_FILE).allowed
      ).toBe(true);
      expect(
        checkPermission(AutonomyLevel.READ_ONLY, OperationType.WRITE_FILE)
          .allowed
      ).toBe(false);

      // LOW can do read + write files
      expect(
        checkPermission(AutonomyLevel.LOW, OperationType.WRITE_FILE).allowed
      ).toBe(true);
      expect(
        checkPermission(AutonomyLevel.LOW, OperationType.GIT_COMMIT).allowed
      ).toBe(false);

      // MEDIUM can do read + write + git local
      expect(
        checkPermission(AutonomyLevel.MEDIUM, OperationType.GIT_COMMIT).allowed
      ).toBe(true);
      expect(
        checkPermission(AutonomyLevel.MEDIUM, OperationType.GIT_PUSH).allowed
      ).toBe(false);

      // HIGH can do everything
      expect(
        checkPermission(AutonomyLevel.HIGH, OperationType.GIT_PUSH).allowed
      ).toBe(true);
      expect(
        checkPermission(AutonomyLevel.HIGH, OperationType.EXTERNAL_API).allowed
      ).toBe(true);
    });
  });
});
